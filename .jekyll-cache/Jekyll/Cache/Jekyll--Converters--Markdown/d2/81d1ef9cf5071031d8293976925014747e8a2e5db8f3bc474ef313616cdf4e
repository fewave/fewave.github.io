I"‰‚<blockquote>
  <p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå„ç³»ç»ŸåŒæ­¥è®¿é—®å…±åŒçš„èµ„æºæ˜¯å¾ˆå¸¸è§çš„ã€‚å› æ­¤æˆ‘ä»¬å¸¸å¸¸éœ€è¦åè°ƒä»–ä»¬çš„åŠ¨ä½œã€‚ å¦‚æœä¸åŒçš„ç³»ç»Ÿæˆ–æ˜¯åŒä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒä¸»æœºä¹‹é—´å…±äº«äº†ä¸€ä¸ªæˆ–ä¸€ç»„èµ„æºï¼Œé‚£ä¹ˆè®¿é—®è¿™äº›èµ„æºçš„æ—¶å€™ï¼Œå¾€å¾€éœ€è¦äº’æ–¥æ¥é˜²æ­¢å½¼æ­¤å¹²æ‰°æ¥ä¿è¯ä¸€è‡´æ€§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¾¿éœ€è¦ä½¿ç”¨åˆ°åˆ†å¸ƒå¼é”ã€‚</p>
</blockquote>

<p><strong><em>ä¸€ä¸ªå¥½çš„åˆ†å¸ƒå¼é”å¸¸å¸¸éœ€è¦ä»¥ä¸‹ç‰¹æ€§:</em></strong></p>
<ul>
  <li>å¯é‡å…¥</li>
  <li>åŒä¸€æ—¶é—´ç‚¹,åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”</li>
  <li>å®¹é”™æ€§, å½“é”èŠ‚ç‚¹å®•æœºæ—¶, èƒ½åŠæ—¶é‡Šæ”¾é”</li>
  <li>é«˜æ€§èƒ½</li>
  <li>æ— å•ç‚¹é—®é¢˜</li>
</ul>

<p><img src="resources/BFCA75ABC7CCC71FFD005833F230E664.png" alt="åˆ†å¸ƒå¼é”.png" /></p>

<h2 id="ä¸€-åŸºäºæ•°æ®åº“çš„åˆ†å¸ƒå¼é”">ä¸€. åŸºäºæ•°æ®åº“çš„åˆ†å¸ƒå¼é”</h2>
<p><img src="resources/3DDC5598A48BA1315E2852A81F3C4A88.jpg" alt="åˆ†å¸ƒå¼é”æµç¨‹å›¾-åŸºäºæ•°æ®åº“åˆ†å¸ƒå¼é”.jpg" />
åŸºäºæ•°æ®åº“çš„åˆ†å¸ƒå¼é”, å¸¸ç”¨çš„ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨è¡¨çš„å”¯ä¸€çº¦æŸç‰¹æ€§ã€‚å½“å¾€æ•°æ®åº“ä¸­æˆåŠŸæ’å…¥ä¸€æ¡æ•°æ®æ—¶, ä»£è¡¨åªè·å–åˆ°é”ã€‚å°†è¿™æ¡æ•°æ®ä»æ•°æ®åº“ä¸­åˆ é™¤ï¼Œåˆ™é‡Šæ”¾é€ã€‚</p>

<p><strong>å› æ­¤éœ€è¦åˆ›å»ºä¸€å¼ é”è¡¨</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`methodLock`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">COMMENT</span> <span class="s1">'ä¸»é”®'</span><span class="p">,</span>
  <span class="nv">`method_name`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span> <span class="k">COMMENT</span> <span class="s1">'é”å®šçš„æ–¹æ³•å'</span><span class="p">,</span>
  <span class="nv">`cust_id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">'å®¢æˆ·ç«¯å”¯ä¸€ç¼–ç '</span><span class="p">,</span>
  <span class="nv">`update_time`</span> <span class="nb">timestamp</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span> <span class="k">COMMENT</span> <span class="s1">'ä¿å­˜æ•°æ®æ—¶é—´ï¼Œè‡ªåŠ¨ç”Ÿæˆ'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">),</span>
  <span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="nv">`uidx_method_name`</span> <span class="p">(</span><span class="nv">`method_name `</span><span class="p">)</span> <span class="k">USING</span> <span class="n">BTREE</span>
<span class="p">)</span>
 <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="k">COMMENT</span><span class="o">=</span><span class="s1">'é”å®šä¸­çš„æ–¹æ³•'</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>æ·»åŠ é”</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">insert</span> <span class="k">into</span> <span class="n">methodLock</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span><span class="n">cust_id</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="err">â€˜</span><span class="n">method_name</span><span class="err">â€™</span><span class="p">,</span><span class="err">â€˜</span><span class="n">cust_id</span><span class="err">â€™</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿™é‡Œcust_id å¯ä»¥æ˜¯æœºå™¨çš„macåœ°å€+çº¿ç¨‹ç¼–å·, ç¡®ä¿ä¸€ä¸ªçº¿ç¨‹åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªç¼–å·ã€‚<strong><em>é€šè¿‡è¿™ä¸ªç¼–å·ï¼Œ å¯ä»¥æœ‰æ•ˆçš„åˆ¤æ–­æ˜¯å¦ä¸ºé”çš„åˆ›å»ºè€…ï¼Œä»è€Œè¿›è¡Œé”çš„é‡Šæ”¾ä»¥åŠé‡å…¥é”åˆ¤æ–­</em></strong></p>

<p><strong>é‡Šæ”¾é”</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">delete</span> <span class="k">from</span> <span class="n">methodLock</span> <span class="k">where</span> <span class="n">method_name</span> <span class="o">=</span><span class="s1">'method_name'</span> <span class="k">and</span> <span class="n">cust_id</span> <span class="o">=</span> <span class="s1">'cust_id'</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>é‡å…¥é”åˆ¤æ–­</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="mi">1</span> <span class="k">from</span> <span class="n">methodLock</span> <span class="k">where</span> <span class="n">method_name</span> <span class="o">=</span><span class="s1">'method_name'</span> <span class="k">and</span> <span class="n">cust_id</span> <span class="o">=</span> <span class="s1">'cust_id'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>åŠ é”ä»¥åŠé‡Šæ”¾é”çš„ä»£ç ç¤ºä¾‹</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="cm">/**
* è·å–é”
*/</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">methodName</span><span class="o">){</span>
    <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">custId</span> <span class="o">=</span> <span class="n">getCustId</span><span class="o">();</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="c1">//æ·»åŠ é”</span>
       <span class="n">success</span> <span class="o">=</span> <span class="n">insertLock</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">custId</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//å¦‚æ·»åŠ å¤±è´¥</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
* é‡Šæ”¾é”
*/</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">String</span> <span class="n">methodName</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">custId</span> <span class="o">=</span> <span class="n">getCustId</span><span class="o">();</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="c1">//æ·»åŠ é”</span>
       <span class="n">success</span> <span class="o">=</span> <span class="n">deleteLock</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">custId</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//å¦‚æ·»åŠ å¤±è´¥</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>å®Œæ•´æµç¨‹</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="s">"methodName"</span><span class="o">;</span>
    <span class="c1">//åˆ¤æ–­æ˜¯å¦é‡å…¥é”</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">checkReentrantLock</span><span class="o">(</span><span class="n">methodName</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">//éé‡å…¥é”</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">lock</span><span class="o">(</span><span class="n">methodName</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//è·å–é”å¤±è´¥, åˆ™é˜»å¡è‡³è·å–é”</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
            <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//TODO ä¸šåŠ¡å¤„ç†</span>

    <span class="c1">//é‡Šæ”¾é”</span>
    <span class="n">unlock</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šä»£ç è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜:</p>
<ul>
  <li>æ²¡æœ‰å¤±æ•ˆæ—¶é—´ã€‚ è§£å†³æ–¹æ¡ˆ:è®¾ç½®ä¸€ä¸ªå®šæ—¶å¤„ç†, å®šæœŸæ¸…ç†è¿‡æœŸé”</li>
  <li>å•ç‚¹é—®é¢˜ã€‚ è§£å†³æ–¹æ¡ˆ: å¼„å‡ ä¸ªå¤‡ä»½æ•°æ®åº“ï¼Œæ•°æ®åº“ä¹‹å‰åŒå‘åŒæ­¥ï¼Œä¸€æ—¦æŒ‚æ‰å¿«é€Ÿåˆ‡æ¢åˆ°å¤‡åº“ä¸Š</li>
</ul>

<h2 id="äºŒ-åŸºäºredisçš„åˆ†å¸ƒå¼é”">äºŒ. åŸºäºredisçš„åˆ†å¸ƒå¼é”</h2>
<p><img src="resources/02CCB742CF1F9A94501EAF776375AF73.jpg" alt="åˆ†å¸ƒå¼é”æµç¨‹å›¾-åŸºäºredisåˆ†å¸ƒå¼é”.jpg" />
ä½¿ç”¨redis çš„set(String key, String value, String nxxx, String expx, int time)å‘½ä»¤</p>
<ul>
  <li>ç¬¬ä¸€ä¸ªä¸ºkeyï¼Œæˆ‘ä»¬ä½¿ç”¨keyæ¥å½“é”ï¼Œå› ä¸ºkeyæ˜¯å”¯ä¸€çš„ã€‚</li>
  <li>ç¬¬äºŒä¸ªä¸ºvalueï¼Œæˆ‘ä»¬ä¼ çš„æ˜¯custIdï¼Œè¿™é‡Œcust_id å¯ä»¥æ˜¯æœºå™¨çš„macåœ°å€+çº¿ç¨‹ç¼–å·, ç¡®ä¿ä¸€ä¸ªçº¿ç¨‹åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªç¼–å·ã€‚<strong><em>é€šè¿‡è¿™ä¸ªç¼–å·ï¼Œ å¯ä»¥æœ‰æ•ˆçš„åˆ¤æ–­æ˜¯å¦ä¸ºé”çš„åˆ›å»ºè€…ï¼Œä»è€Œè¿›è¡Œé”çš„é‡Šæ”¾ä»¥åŠé‡å…¥é”åˆ¤æ–­</em></strong></li>
  <li>ç¬¬ä¸‰ä¸ªä¸ºnxxxï¼Œè¿™ä¸ªå‚æ•°æˆ‘ä»¬å¡«çš„æ˜¯NXï¼Œæ„æ€æ˜¯SET IF NOT EXISTï¼Œå³å½“keyä¸å­˜åœ¨æ—¶ï¼Œæˆ‘ä»¬è¿›è¡Œsetæ“ä½œï¼›è‹¥keyå·²ç»å­˜åœ¨ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ</li>
  <li>ç¬¬å››ä¸ªä¸ºexpxï¼Œè¿™ä¸ªå‚æ•°æˆ‘ä»¬ä¼ çš„æ˜¯PXï¼Œæ„æ€æ˜¯æˆ‘ä»¬è¦ç»™è¿™ä¸ªkeyåŠ ä¸€ä¸ªè¿‡æœŸçš„è®¾ç½®ï¼Œå…·ä½“æ—¶é—´ç”±ç¬¬äº”ä¸ªå‚æ•°å†³å®šã€‚</li>
  <li>ç¬¬äº”ä¸ªä¸ºtimeï¼Œä¸ç¬¬å››ä¸ªå‚æ•°ç›¸å‘¼åº”ï¼Œä»£è¡¨keyçš„è¿‡æœŸæ—¶é—´ã€‚</li>
</ul>

<p><strong>ä»£ç ç¤ºä¾‹</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LOCK_SUCCESS</span> <span class="o">=</span> <span class="s">"OK"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_IF_NOT_EXIST</span> <span class="o">=</span> <span class="s">"NX"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SET_WITH_EXPIRE_TIME</span> <span class="o">=</span> <span class="s">"PX"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="no">RELEASE_SUCCESS</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

<span class="c1">// Rediså®¢æˆ·ç«¯</span>
<span class="kd">private</span> <span class="nc">Jedis</span> <span class="n">jedis</span><span class="o">;</span>

<span class="cm">/**
 * å°è¯•è·å–åˆ†å¸ƒå¼é”
 * @param lockKey é”
 * @param expireTime è¶…æœŸæ—¶é—´
 * @return æ˜¯å¦è·å–æˆåŠŸ
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockKey</span><span class="o">,</span> <span class="kt">int</span> <span class="n">expireTime</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">custId</span> <span class="o">=</span> <span class="n">getCustId</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">custId</span><span class="o">,</span> <span class="no">SET_IF_NOT_EXIST</span><span class="o">,</span> <span class="no">SET_WITH_EXPIRE_TIME</span><span class="o">,</span> <span class="n">expireTime</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="no">LOCK_SUCCESS</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * é‡Šæ”¾åˆ†å¸ƒå¼é”
 * @param lockKey é”
 * @param requestId è¯·æ±‚æ ‡è¯†
 * @return æ˜¯å¦é‡Šæ”¾æˆåŠŸ
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockKey</span><span class="o">,)</span> <span class="o">{</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">custId</span> <span class="o">=</span> <span class="n">getCustId</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">script</span> <span class="o">=</span> <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span><span class="o">;</span>
    <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">script</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lockKey</span><span class="o">),</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">custId</span><span class="o">));</span>

    <span class="k">if</span> <span class="o">(</span><span class="no">RELEASE_SUCCESS</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * è·å–é”ä¿¡æ¯
 * @param lockKey é”
 * @return æ˜¯å¦é‡å…¥é”
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkReentrantLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockKey</span><span class="o">){</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">custId</span> <span class="o">=</span> <span class="n">getCustId</span><span class="o">();</span>

    <span class="c1">//è·å–å½“å‰é”çš„å®¢æˆ·å”¯ä¸€è¡¨ç¤ºç </span>
    <span class="nc">String</span> <span class="n">currentCustId</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">lockKey</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">custId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">currentCustId</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>å®Œæ•´æµç¨‹</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">lockKey</span> <span class="o">=</span> <span class="s">"lockKey"</span><span class="o">;</span>
    <span class="c1">//åˆ¤æ–­æ˜¯å¦é‡å…¥é”</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">checkReentrantLock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">//éé‡å…¥é”</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">lock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//è·å–é”å¤±è´¥, åˆ™é˜»å¡è‡³è·å–é”</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
            <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//TODO ä¸šåŠ¡å¤„ç†</span>

    <span class="c1">//é‡Šæ”¾é”</span>
    <span class="n">unlock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰-åŸºäºmemcachedçš„åˆ†å¸ƒå¼é”">ä¸‰. åŸºäºmemcachedçš„åˆ†å¸ƒå¼é”</h2>
<p><img src="resources/D9D2C5A96C3994C89765A45BB7DA2D64.jpg" alt="åˆ†å¸ƒå¼é”æµç¨‹å›¾-åŸºäºmemcachedåˆ†å¸ƒå¼é”.jpg" /></p>

<p>memcachedçš„å®ç°æ–¹å¼å’Œredisç±»ä¼¼, ä½¿ç”¨çš„æ˜¯å‘½ä»¤add(key, value, expireDate),æ³¨:ä»…å½“ç¼“å­˜ä¸­ä¸å­˜åœ¨é”®æ—¶ï¼Œæ‰ä¼šæ·»åŠ æˆåŠŸ</p>
<ul>
  <li>ç¬¬ä¸€ä¸ªä¸ºkeyï¼Œæˆ‘ä»¬ä½¿ç”¨keyæ¥å½“é”ï¼Œå› ä¸ºkeyæ˜¯å”¯ä¸€çš„ã€‚</li>
  <li>ç¬¬äºŒä¸ªä¸ºvalueï¼Œæˆ‘ä»¬ä¼ çš„æ˜¯custIdï¼Œè¿™é‡Œcust_id</li>
  <li>ç¬¬ä¸‰ä¸ªä¸ºexpireDate, è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´,æ¯”å¦‚ï¼š new Date(1000*10)ï¼Œåˆ™è¡¨ç¤ºåç§’ä¹‹åä»Memcachedå†…å­˜ç¼“å­˜ä¸­åˆ é™¤ï¼‰ã€‚</li>
</ul>

<p><strong>ä»£ç ç¤ºä¾‹</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="c1">// Rediså®¢æˆ·ç«¯</span>
<span class="kd">private</span> <span class="nc">MemCachedClient</span> <span class="n">memCachedClient</span><span class="o">;</span>

<span class="cm">/**
 * å°è¯•è·å–åˆ†å¸ƒå¼é”
 * @param lockKey é”
 * @param expireTime è¶…æœŸæ—¶é—´
 * @return æ˜¯å¦è·å–æˆåŠŸ
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockKey</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">expireDate</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">custId</span> <span class="o">=</span> <span class="n">getCustId</span><span class="o">();</span>
    <span class="nc">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">memCachedClient</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">custId</span><span class="o">,</span><span class="n">expireDate</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Excetion</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * é‡Šæ”¾åˆ†å¸ƒå¼é”
 * @param lockKey é”
 * @param requestId è¯·æ±‚æ ‡è¯†
 * @return æ˜¯å¦é‡Šæ”¾æˆåŠŸ
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockKey</span><span class="o">,)</span> <span class="o">{</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">custId</span> <span class="o">=</span> <span class="n">getCustId</span><span class="o">();</span>
    <span class="nc">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">currentCustId</span> <span class="o">=</span> <span class="n">memCachedClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">lockKey</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">custId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">currentCustId</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">memCachedClient</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">custId</span><span class="o">,</span><span class="n">expireDate</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Excetion</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * è·å–é”ä¿¡æ¯
 * @param lockKey é”
 * @return æ˜¯å¦é‡å…¥é”
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkReentrantLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockKey</span><span class="o">){</span>
    <span class="c1">//è·å–å®¢æˆ·å”¯ä¸€è¯†åˆ«ç ,ä¾‹å¦‚:mac+çº¿ç¨‹ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">custId</span> <span class="o">=</span> <span class="n">getCustId</span><span class="o">();</span>
    <span class="c1">//è·å–å½“å‰é”çš„å®¢æˆ·å”¯ä¸€è¡¨ç¤ºç </span>
    <span class="k">try</span> <span class="o">{</span>
         <span class="nc">String</span> <span class="n">currentCustId</span> <span class="o">=</span> <span class="n">memCachedClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">lockKey</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">custId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">currentCustId</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Excetion</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>å®Œæ•´æµç¨‹</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">lockKey</span> <span class="o">=</span> <span class="s">"lockKey"</span><span class="o">;</span>
    <span class="c1">//åˆ¤æ–­æ˜¯å¦é‡å…¥é”</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">checkReentrantLock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">//éé‡å…¥é”</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">lock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//è·å–é”å¤±è´¥, åˆ™é˜»å¡è‡³è·å–é”</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
            <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//TODO ä¸šåŠ¡å¤„ç†</span>

    <span class="c1">//é‡Šæ”¾é”</span>
    <span class="n">unlock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››-åŸºäºzookeeperçš„åˆ†å¸ƒå¼é”">å››. åŸºäºzookeeperçš„åˆ†å¸ƒå¼é”</h2>
<p><img src="resources/5C6C92F2A132891D116D3D2665553839.jpg" alt="åˆ†å¸ƒå¼é”æµç¨‹å›¾-åŸºäºzookeeperåˆ†å¸ƒå¼é”.jpg" /></p>
<blockquote>
  <p>åŸºäºzookeeperä¸´æ—¶æœ‰åºèŠ‚ç‚¹å¯ä»¥å®ç°çš„åˆ†å¸ƒå¼é”ã€‚
å¤§è‡´æ€æƒ³å³ä¸ºï¼šæ¯ä¸ªå®¢æˆ·ç«¯å¯¹æŸä¸ªæ–¹æ³•åŠ é”æ—¶ï¼Œåœ¨zookeeperä¸Šçš„ä¸è¯¥æ–¹æ³•å¯¹åº”çš„æŒ‡å®šèŠ‚ç‚¹çš„ç›®å½•ä¸‹ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ç¬æ—¶æœ‰åºèŠ‚ç‚¹ã€‚ åˆ¤æ–­æ˜¯å¦è·å–é”çš„æ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦åˆ¤æ–­æœ‰åºèŠ‚ç‚¹ä¸­åºå·æœ€å°çš„ä¸€ä¸ªã€‚ å½“é‡Šæ”¾é”çš„æ—¶å€™ï¼Œåªéœ€å°†è¿™ä¸ªç¬æ—¶èŠ‚ç‚¹åˆ é™¤å³å¯ã€‚åŒæ—¶ï¼Œå…¶å¯ä»¥é¿å…æœåŠ¡å®•æœºå¯¼è‡´çš„é”æ— æ³•é‡Šæ”¾ï¼Œè€Œäº§ç”Ÿçš„æ­»é”é—®é¢˜ã€‚</p>
</blockquote>

<p>å¯ä»¥ç›´æ¥ä½¿ç”¨zookeeperç¬¬ä¸‰æ–¹åº“Curatorå®¢æˆ·ç«¯ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯ä¸­å°è£…äº†ä¸€ä¸ªå¯é‡å…¥çš„é”æœåŠ¡ã€‚</p>

<p><strong>å®Œæ•´æµç¨‹</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//Curatoræä¾›çš„InterProcessMutexæ˜¯åˆ†å¸ƒå¼é”çš„å®ç°ã€‚é€šè¿‡acquireè·å¾—é”ï¼Œå¹¶æä¾›è¶…æ—¶æœºåˆ¶ï¼Œreleaseæ–¹æ³•ç”¨äºé‡Šæ”¾é”ã€‚</span>
    <span class="nc">InterProcessMutex</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InterProcessMutex</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="no">ZK_LOCK_PATH</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//è·å–é”</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">acquire</span><span class="o">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//TODO ä¸šåŠ¡å¤„ç†</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//é‡Šæ”¾é”</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET